# terraform-aci-tenant-object
Terraform module to build a ACI Tenant in entirety from single HCL/JSON nested object variable file.  This should simplify tenant configuration and allow for easier configuration changes and rollbacks.  

This module also support re-using existing configuration through an optional `use_existing` parameter at most levels.  This allows Terraform to manage child objects without fully managing the parent object (i.e. Terraform can add VRFs to the common tenant without disturbing existing configuration).  

Where appropriate, the module will also allow re-using configuration from other tenants though this assumes the configuraiton is already present in that tenant (i.e. common filters or shared L3outs can be leveraged from the common tenant).

This module is used in the DevNet example ACI Day 2 Terraform Examples where the same tenant configuration can evolve over time from a simple "network centric" deployment to a full "application centric" deployment including Layer 4 contracts with optional policy-based redirect (PBR) service graph, by slowing changing the tenant configuration code.

Please see this link for examples of how this module is used.
[ACI Day 2 Automation with Terraform](https://github.com/cisco-apjc-cloud-se/aci-basic-day2)

The input variable object for this module is structured on the ACI Tenant tab (ACI 5.2+).  The following configuration items are supported.  

- Applications Profiles (aps)
  - End Point Groups (epgs)
    - Static with physical path
    - Dynamic with VMM domain support
  - Endpoint Security Groups (esgs)
    - EPG to ESG support
- Contracts
  - Standard Contracts
  - Filters
- Networking
  - Bridge Domains
    - optional Layer 3 Subnet support
  - L3 Outs (one or more)
    - External EPGs
    - Routed, Sub-interface, SVI and Floating SVI support
    - OSPF, BGP peering support
  - VRFs
    - Optional Preferred Group support
- Policies
  - L4-7 Policy Based Redirection
- Services
  - L4-7 Policy Based Routing Support

## Caveats
While care has been taken to reduce the number of cross-references, it may be possible to refer to an object that does not exist yet. Examples identified currently are:
- Creating L3Out External Endpoint Group(ExtEPGs) with Contract Master ExtEPG in the same tenant.  It is possible that referenced ExtEPG maynot be created when the ExtEPG with the Control Master configuration is created.  The only workaround for this is to ensure the Contract Master ExtEPG is created first by running the configuration plan twice.
- Creating a L4-7 Service Graph Template instance on a Contract Subject using a Bridge Domain between the Device and the ACI fabric.  It is possible the Bridge Domain will not be built before the L4-7 Service Graph instance is created.  Again, the work around is to build the necessary Bridge Domains, L4-7 Devices and PBR policies in one plan, then apply the service graph template to the contrct subject in a later plan.

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_aci"></a> [aci](#requirement\_aci) | >=2.0.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aci"></a> [aci](#provider\_aci) | >=2.0.0 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_aps"></a> [aps](#module\_aps) | ./modules/aps | n/a |
| <a name="module_contracts"></a> [contracts](#module\_contracts) | ./modules/contracts | n/a |
| <a name="module_networking"></a> [networking](#module\_networking) | ./modules/networking | n/a |
| <a name="module_policies"></a> [policies](#module\_policies) | ./modules/policies | n/a |
| <a name="module_services"></a> [services](#module\_services) | ./modules/services | n/a |

## Resources

| Name | Type |
|------|------|
| [aci_tenant.tenant](https://registry.terraform.io/providers/CiscoDevNet/aci/latest/docs/resources/tenant) | resource |
| [aci_tenant.tenant](https://registry.terraform.io/providers/CiscoDevNet/aci/latest/docs/data-sources/tenant) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_tenant"></a> [tenant](#input\_tenant) | # New Single-Object Tenant Model ## | <pre>object({<br>    name          = string<br>    # id            = optional(string)<br>    use_existing  = optional(bool)<br>    description   = optional(string)<br>    ### Application Profiles ###<br>    aps = map(object({<br>      ap_name       = string<br>      use_existing  = optional(bool)<br>      # tenant_name = string<br>      description   = string<br>      #### Endpoint Security Groups (ESG) ####<br>      esgs = map(object({<br>        esg_name        = string<br>        use_existing    = optional(bool)<br>        # vrf_name        = string<br>        vrf = object({<br>          tenant_name = optional(string)<br>          vrf_name    = string<br>        })<br>        description     = string<br>        preferred_group = string<br>        consumed_contracts = map(object({<br>          tenant_name   = optional(string)<br>          contract_name = string<br>        }))<br>        provided_contracts = map(object({<br>          tenant_name   = optional(string)<br>          contract_name = string<br>        }))<br>      }))<br>      #### Endpoint Groups (EPG) ####<br>      epgs = map(object({<br>        epg_name      = string<br>        use_existing  = optional(bool)<br>        # bd_name   = string<br>        bd = object({<br>          tenant_name = optional(string)<br>          bd_name = string<br>        })<br>        description = string<br>        domains = map(object({<br>          name = string<br>          type = string<br>          vmm_allow_promiscuous = optional(string)<br>          vmm_forged_transmits  = optional(string)<br>          vmm_mac_changes       = optional(string)<br>          }))<br>        mapped_esg = object({<br>          # tenant_name = optional(string)<br>          esg_name    = optional(string)<br>          })<br>        preferred_group = optional(string)<br>        paths = map(object({<br>          pod       = number<br>          leaf_node = number<br>          port      = string<br>          vlan_id   = number<br>          mode      = string<br>          }))<br>        }))<br>    }))<br>    ### Networking ###<br>    networking = object({<br>      #### VRFS ####<br>      vrfs = map(object({<br>        vrf_name        = string<br>        use_existing    = optional(bool)<br>        description     = string<br>        # tenant_name     = string<br>        preferred_group = string<br>      }))<br>      #### Bridge Domains ####<br>      bds = map(object({<br>        bd_name       = string<br>        use_existing  = optional(bool)<br>        vrf = object({<br>          tenant_name = optional(string)<br>          vrf_name    = string<br>          })<br>        # vrf_name      = string<br>        description   = string<br>        # tenant_name   = string<br>        arp_flood     = string<br>        mac_address   = string<br>        l3outs        = map(object({<br>          tenant_name = optional(string)<br>          l3out_name  = string<br>          }))<br>        subnets = map(object({<br>          description   = string<br>          ip            = string<br>          scope         = list(string)<br>          preferred     = string<br>          }))<br>      }))<br>      #### L3Outs ####<br>      l3outs = map(object({<br>        l3out_name    = string<br>        use_existing  = optional(bool)<br>        description   = string<br>        vrf = object({<br>          tenant_name = optional(string)<br>          vrf_name    = string<br>          })<br>        l3_domain     = string<br>        ### Enable BGP ####<br>        bgp_policy = object({<br>          enabled     = optional(bool)<br>          description = optional(string)<br>          annotation  = optional(string)<br>          name_alias  = optional(string)<br>          })<br>        #### Enable OSPF ####<br>        ospf_policy = object({<br>          enabled     = optional(bool)<br>          description = optional(string)<br>          area_cost   = optional(number)<br>          area_id     = optional(string)<br>          area_type   = optional(string)<br>          })<br>        #### Logical Profiles ####<br>        logical_node_profiles = map(object({<br>          lprof_name    = string<br>          use_existing  = optional(bool)<br>          description   = string<br>          bgp_peers = map(object({<br>            peer_ip                         = string<br>            peer_asn                        = number<br>            addr_t_ctrl                     = optional(list(string))<br>            admin_state                     = optional(string)<br>            allowed_self_as_cnt             = optional(number)<br>            description                     = optional(string)<br>            annotation                      = optional(string)<br>            ctrl                            = optional(list(string))<br>            name_alias                      = optional(string)<br>            password                        = optional(string)<br>            peer_ctrl                       = optional(list(string))<br>            private_a_sctrl                 = optional(list(string))<br>            ttl                             = optional(number)<br>            weight                          = optional(number)<br>            local_asn                       = optional(number)<br>            local_asn_propagate             = optional(string)<br>            peer_prefix_policy              = optional(string)<br>            route_control_profiles          = map(object({<br>              direction = optional(string)<br>              target_dn = string<br>            }))<br>          }))<br>          nodes = map(object({<br>            pod         = number<br>            leaf_node   = number<br>            loopback_ip = string<br>          }))<br>          interface_profiles = map(object({<br>            intprof_name = string<br>            description  = string<br>            ospf_profile = object({<br>              enabled     = optional(bool)<br>              description = optional(string)<br>              auth_key    = optional(string)<br>              auth_key_id = optional(number)<br>              auth_type   = optional(string)<br>              ospf_policy = object({<br>                tenant_name = optional(string)<br>                policy_name = optional(string)<br>                })<br>            })<br>            floating_svis = map(object({<br>              pod         = number<br>              node        = number<br>              vlan_id     = number<br>              ip          = string ## Anchor Node IP<br>              description = optional(string)<br>              domains     = map(object({<br>                name              = string<br>                type              = string<br>                floating_ip       = optional(string)<br>                forged_transmit   = optional(string)<br>                mac_change        = optional(string)<br>                promiscuous_mode  = optional(string)<br>                }))<br>              }))<br>            paths = map(object({<br>              description     = string<br>              path_type       = string<br>              ip              = optional(string)<br>              vlan_id         = optional(number)<br>              interface_type  = string<br>              port = object({<br>                pod       = optional(number)<br>                node      = optional(number)<br>                port_name = optional(string)  ## Includes Direct Port Channel<br>              })<br>              vpc = object({<br>                pod         = optional(number)<br>                vpc_name    = optional(string)<br>                side_a = object({<br>                  node          = optional(number)<br>                  ip            = optional(string)<br>                  annotation    = optional(string)<br>                  ipv6_dad      = optional(string)<br>                  ll_addr       = optional(string)<br>                  description   = optional(string)<br>                  name_alias    = optional(string)<br>                })<br>                side_b = object({<br>                  node          = optional(number)<br>                  ip            = optional(string)<br>                  annotation    = optional(string)<br>                  ipv6_dad      = optional(string)<br>                  ll_addr       = optional(string)<br>                  description   = optional(string)<br>                  name_alias    = optional(string)<br>                })<br>              })<br>              annotation  = optional(string)<br>              autostate   = optional(string)<br>              encap_scope = optional(string)<br>              ipv6_dad    = optional(string)<br>              ll_addr     = optional(string)<br>              mac         = optional(string)<br>              mode        = optional(string)<br>              mtu         = optional(string)<br>              target_dscp = optional(string)<br>              bgp_peers   = map(object({<br>                peer_ip                         = string # addr<br>                peer_asn                        = number # as_number<br>                addr_t_ctrl                     = optional(list(string)) # Ucast/Mcast Addr Type AF Control. (Multiple Comma-Delimited values are allowed. E.g., "af-mcast,af-ucast"). Apply "" to clear all the values. Allowed values: "af-mcast", "af-ucast". Default value: "af-ucast".<br>                admin_state                     = optional(string) # Allowed values are "disabled", "enabled", and default value is "enabled"<br>                allowed_self_as_cnt             = optional(number) # Default value: "3".<br>                description                     = optional(string)<br>                annotation                      = optional(string)<br>                ctrl                            = optional(list(string)) # Allowed values: "allow-self-as", "as-override", "dis-peer-as-check", "nh-self", "send-com", "send-ext-com"<br>                name_alias                      = optional(string)<br>                password                        = optional(string) # If password is set, the peer password will reset when terraform configuration is applied.<br>                peer_ctrl                       = optional(list(string)) # Allowed values: "bfd", "dis-conn-check".<br>                private_a_sctrl                 = optional(list(string)) # Allowed values: "remove-all", "remove-exclusive", "replace-as".<br>                ttl                             = optional(number) # Default value: "1".<br>                weight                          = optional(number) # Default value: "0".<br>                local_asn                       = optional(number)<br>                local_asn_propagate             = optional(string) # Allowed values: "dual-as", "no-prepend", "none", "replace-as". Default value: "none".<br>                peer_prefix_policy              = optional(string)<br>                route_control_profiles          = map(object({<br>                  direction = optional(string) # Allowed values are "export", "import", and default value is "import".<br>                  target_dn = string<br>                }))<br>              }))<br>            }))<br>          }))<br>        }))<br>        #### External Endpoint Groups (ExEPG) ####<br>        external_epgs = map(object({<br>          extepg_name     = string<br>          use_existing    = optional(bool)<br>          description     = string<br>          preferred_group = string<br>          consumed_contracts = map(object({<br>            tenant_name   = optional(string)<br>            contract_name = string<br>          }))<br>          provided_contracts = map(object({<br>            tenant_name   = optional(string)<br>            contract_name = string<br>          }))<br>          contract_master_epgs = map(object({<br>            l3out_name = string<br>            extepg_name = string<br>          }))<br>          subnets = map(object({<br>            description = string<br>            aggregate   = string<br>            ip          = string<br>            scope       = list(string)<br>          }))<br>        }))<br>      }))<br>    })<br>    ### Contracts & Filters ###<br>    contracts = object({<br>      #### Standard Contracts ###<br>      standard = map(object({<br>        contract_name = string<br>        tenant_name   = optional(string)<br>        use_existing  = optional(bool)<br>        description   = optional(string)<br>        scope         = optional(string)<br>        subjects = map(object({<br>          subject_name  = string<br>          description   = optional(string)<br>          filters       = map(object({<br>            filter_name = string<br>            tenant_name = optional(string)<br>          }))<br>          service_graph = object({<br>            tenant_name = optional(string)<br>            template_name = optional(string)<br>            nodes = map(object({<br>              node_name     = string<br>              device = object({<br>                tenant_name = optional(string)<br>                device_name = string<br>              })<br>              annotation    = optional(string)<br>              description   = optional(string)<br>              context       = optional(string)<br>              name_alias    = optional(string)<br>              router_config = optional(string)<br>              consumer_interface = object({<br>                type                = string<br>                conn_name           = string<br>                cluster_interface   = string<br>                l3_dest             = optional(string)<br>                redirect_policy     = optional(string)<br>                service_epg_policy  = optional(string)<br>                annotation          = optional(string)<br>                description         = optional(string)<br>                name_alias          = optional(string)<br>                permit_log          = optional(string)<br>                bd = object({<br>                  tenant_name = optional(string)<br>                  bd_name     = optional(string)<br>                })<br>                extepg = object({<br>                  tenant_name = optional(string)<br>                  l3out_name  = optional(string)<br>                  extepg_name = optional(string)<br>                })<br>              })<br>              provider_interface = object({<br>                type                = string<br>                conn_name           = string<br>                cluster_interface   = string<br>                l3_dest             = optional(string)<br>                redirect_policy     = optional(string)<br>                service_epg_policy  = optional(string)<br>                annotation          = optional(string)<br>                description         = optional(string)<br>                name_alias          = optional(string)<br>                permit_log          = optional(string)<br>                bd = object({<br>                  tenant_name = optional(string)<br>                  bd_name     = optional(string)<br>                })<br>                extepg = object({<br>                  tenant_name = optional(string)<br>                  l3out_name  = optional(string)<br>                  extepg_name = optional(string)<br>                })<br>              })<br>            }))<br>          })<br>        }))<br>      }))<br>      #### Filters ####<br>      filters = map(object({<br>        filter_name   = string<br>        use_existing  = optional(bool)<br>        tenant_name   = optional(string)<br>        description   = string<br>        entries = map(object({<br>          name        = string<br>          description = string<br>          ether_t     = string<br>          d_from_port = string<br>          d_to_port   = string<br>          prot        = string<br>          s_from_port = string<br>          s_to_port   = string<br>          }))<br>      }))<br>    })<br>    ### Policies ###<br>    policies = object({<br>      service_redirect_policies = map(object({<br>        policy_name             = string<br>        name_alias              = optional(string)<br>        use_existing            = optional(bool)<br>        description             = optional(string)<br>        dest_type               = optional(string)<br>        min_threshold_percent   = optional(number)<br>        max_threshold_percent   = optional(number)<br>        hashing_algorithm       = optional(string)<br>        anycast_enabled         = optional(string)<br>        program_local_pod_only  = optional(string)<br>        resilient_hash_enabled  = optional(string)<br>        threshold_enable        = optional(string)<br>        threshold_down_action   = optional(string)<br>        ipsla_policy            = optional(string)<br>        destinations = map(object({<br>          ip            = string<br>          mac           = string<br>          annotation    = optional(string)<br>          description   = optional(string)<br>          dest_name     = optional(string)<br>          ip2           = optional(string)<br>          name_alias    = optional(string)<br>          pod_id        = optional(number)<br>          health_group  = optional(string)<br>        }))<br>      }))<br>    })<br>    ### Services ###<br>    services = object({<br>      l4-l7 = object({<br>        devices = map(object({<br>          device_name      = string<br>          active           = optional(string)<br>          context_aware    = optional(string)<br>          device_type      = optional(string) # Allowed values are "cloud", "physical", "virtual", and default value is "physical" NOTE: Resource needs capitalization<br>          function_type    = optional(string)<br>          is_copy          = optional(string)<br>          mode             = optional(string)<br>          promiscuous_mode = optional(string)<br>          service_type     = optional(string) # Allowed values are "ADC", "COPY", "FW", "NATIVELB", "OTHERS", and default value is "OTHERS NOTE: Resource needs capitalization<br>          trunking         = optional(string)<br>          domain = object({<br>            name = string<br>            type = string<br>          })<br>          concrete_devices = map(object({<br>            device_name         = string<br>            annotation          = optional(string)<br>            name_alias          = optional(string)<br>            vmm_controller_name = optional(string)<br>            vm_name             = optional(string)<br>            interfaces = map(object({<br>              interface_name  = string<br>              encap           = optional(string)<br>              vnic_name       = optional(string)<br>              pod             = optional(number)<br>              node            = optional(number)<br>              port            = optional(string)<br>            }))<br>          }))<br>          logical_interfaces = map(object({<br>            interface_name            = string<br>            annotation                = optional(string)<br>            encap                     = optional(string)<br>            enhanced_lag_policy_name  = optional(string)<br>          }))<br>        }))<br>        service_graph_templates = map(object({<br>          template_name                     = string<br>          annotation                        = optional(string)<br>          name_alias                        = optional(string)<br>          description                       = optional(string)<br>          l4_l7_service_graph_template_type = optional(string)<br>          ui_template_type                  = string<br>          term_prov_name                    = optional(string)<br>          term_cons_name                    = optional(string)<br>          function_nodes = map(object({<br>            node_name           = string<br>            annotation          = optional(string)<br>            description         = optional(string)<br>            func_template_type  = string<br>            func_type           = optional(string)<br>            is_copy             = optional(string)<br>            managed             = optional(string)<br>            name_alias          = optional(string)<br>            routing_mode        = string<br>            sequence_number     = number<br>            share_encap         = optional(string)<br>            device              = object({<br>              tenant_name = optional(string)<br>              device_name = string<br>            })<br>          }))<br>        }))<br>      })<br>    })<br>  })</pre> | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_ap_id_list"></a> [ap\_id\_list](#output\_ap\_id\_list) | n/a |
| <a name="output_bd_map"></a> [bd\_map](#output\_bd\_map) | n/a |
| <a name="output_contract_map"></a> [contract\_map](#output\_contract\_map) | n/a |
| <a name="output_epg_map"></a> [epg\_map](#output\_epg\_map) | n/a |
| <a name="output_internal_testing"></a> [internal\_testing](#output\_internal\_testing) | n/a |
| <a name="output_l3out_map"></a> [l3out\_map](#output\_l3out\_map) | n/a |
| <a name="output_vrf_map"></a> [vrf\_map](#output\_vrf\_map) | n/a |
<!-- END_TF_DOCS -->
